#!/usr/bin/env python

import sys
import os
import requests
import string
import random
from xml.etree import ElementTree
if int(sys.argv[1]) == 110 or int(sys.argv[1]) == 203:
  sys.exit("ERROR: Episodes 110 \"Turning the Tides\" and 203 \"Civil Wars, Part 1\" are disabled.")
if int(sys.argv[2])>7:
  sys.exit ("ERROR: Invalid output type.  Use types 1-7, see https://github.com/iggyvolz/korra-dl/wiki/Output-Types for details")
episodehash={
  101:"11f4711a-4d56-4961-97f6-ee3fded0ed3a"
  102:"3176b6af-dda9-4b3b-a725-0fbc9c897c24"
  103:"677764c4-f9a0-40e0-b732-07e5e8667518"
  104:"e70efbd2-4e08-446f-83b5-157b832b103c"
  105:"db9b0e33-20c4-40b8-8502-87982f2e1f77"
  106:"3410f6c9-cb0d-4377-8c9e-31ee43059b39"
  107:"6eb252e0-ced7-4fef-93ff-9257a53bf487"
  108:"e4c38fbc-7aed-422d-88b7-54f296fb645e"
  109:"918ce68b-3f27-4b10-b26c-5fd1337b1764"
  111:"2b5e6b8f-998f-4b82-990a-d214bdb1d8f0"
  112:"b01da5ef-788d-4ab4-bead-fb9e86b5a331"
  201:"c77b1672-9df2-4667-bb01-e18c3e96b365"
  202:"0e71cebe-c96e-4e65-b9ea-b161c13ceaf5"
  204:"526c55a9-ba53-47bb-8040-b84fc69928a9"
  205:"27d1b9a5-e68e-423b-b2da-91b6c8378d89"
  206:"da44f996-9965-4e8b-844b-bf8356e6a717"
  207:"81270893-a6e0-46a6-acad-6096a389bd0d"
  208:"e41f8483-be7f-477f-8acf-3796801a3d45"
  209:"2684710b-7ace-473c-9083-669d19e0b3d1"
  210:"8d518119-23b8-47c9-bb67-5d26531f6fb5"
  211:"41c6dd6f-6d74-4d80-aa6c-9c4e7eea2f12"
  212:"c198aa79-a353-4ff7-8ffb-ae09fff37f0f"
  213:"06cf967a-780c-495d-8b1f-d437b78779d7"
  214:"62e41b99-793a-4d41-bd38-6418d5c32e8b"
  301:"b6845e1c-fe58-11e2-8a73-0026b9414f30"
  302:"b6845ec6-fe58-11e2-8a73-0026b9414f30"
  303:"b6845f3e-fe58-11e2-8a73-0026b9414f30"
  304:"b6845fac-fe58-11e2-8a73-0026b9414f30"
  305:"b684602e-fe58-11e2-8a73-0026b9414f30"
  306:"b684609c-fe58-11e2-8a73-0026b9414f30"
  307:"b684611e-fe58-11e2-8a73-0026b9414f30"
  308:"b6846196-fe58-11e2-8a73-0026b9414f30"
  309:"b6846218-fe58-11e2-8a73-0026b9414f30"
  310:"b6846286-fe58-11e2-8a73-0026b9414f30"
  311:"ab6c4cfc-3ee9-4127-b703-a4c6f46fe0a9"
  312:"4d5937ac-df18-4c19-9c34-fb236034bc86"
  313:"4d5937ac-df18-4c19-9c34-fb236034bc86" ## All one episode on Nick... find some way to split???
  }.get(int(sys.argv[1]),None)
if episodehash is None:
  sys.exit("ERROR: Invalid episode number.  Episode numbers should be in the following format: Season number (1-3) followed by episode number (01-14)")
r=requests.get("http://udat.mtvnservices.com/service1/dispatch.htm?feed=nick_arc_player_prime&plugin.stage=live&mgid=mgid:arc:episode:nick.com:"+episodehash)
randomstring=''.join(random.choice(string.ascii_uppercase + string.digits) for _ in range(10))
for (i,item) in enumerate(ElementTree.XML(r.text)[0].findall("item")):
  s=requests.get(item[4][0].get("url"))
  url=ElementTree.XML(s.text)[0][0][int(sys.argv[2])-1][0].text
  if os.name == "nt":
    os.system("ffmpeg -i "+url+" \%temp\%\\korra-dl-"+randomstring+"_"+str(i)+".mp4")
    os.system('echo "file \'\%temp\%\\korra-dl-'+randomstring+'_'+str(i)+'.mp4\'">>\%temp\%\\korra-dl-'+randomstring+'_cache')
  else:
    os.system("ffmpeg -i "+url+" /tmp/korra-dl-"+randomstring+"_"+str(i)+".mp4")
    os.system('echo "file \'/tmp/korra-dl-'+randomstring+'_'+str(i)+'.mp4\'">>/tmp/korra-dl-'+randomstring+'_cache')
if os.name == "nt":
  os.system('ffmpeg -f concat -i \%temp\%\\korra-dl-'+randomstring+'_cache -c copy '+sys.argv[3])
  os.system('unlink \%temp\%\\korra-dl*')
else:
  os.system('ffmpeg -f concat -i /tmp/korra-dl-'+randomstring+'_cache -c copy '+sys.argv[3])
  os.system('unlink /tmp/korra-dl*')
